id: websocket-origin-bypass-oob

info:
  name: WebSocket Origin Validation Bypass OOB Detection
  author: geeknik
  severity: high
  description: |
    Detects WebSocket endpoints with weak origin validation that can be bypassed
    to establish cross-origin connections and trigger external callbacks through
    origin spoofing, subdomain takeover scenarios, or referer manipulation.
  reference:
    - https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking
    - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/10-Testing_WebSockets
    - https://christian-schneider.net/CrossSiteWebSocketHijacking.html
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:L/A:N
    cvss-score: 8.1
    cwe-id: CWE-346
  tags: websocket,oob,csrf,origin-bypass,cross-origin

variables:
  callback_url: "{{interactsh-url}}"
  ws_base: "{{replace(replace(BaseURL, 'https://', 'wss://'), 'http://', 'ws://')}}"

websocket:
  - address: "{{ws_base}}{{ws_path}}"
    payloads:
      ws_path:
        - "/ws"
        - "/websocket"
        - "/socket.io/"
        - "/api/ws"

    headers:
      Origin: "{{callback_url}}"
      Referer: "{{callback_url}}/ws-client"

    inputs:
      - data: |
          {
            "type": "origin_test",
            "callback_url": "{{callback_url}}/origin-bypass",
            "external_origin": "{{callback_url}}"
          }
      - data: |
          {
            "action": "cross_origin_check",
            "origin": "{{callback_url}}",
            "allowed_origins": ["{{callback_url}}"],
            "callback_url": "{{callback_url}}/validated"
          }
    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
        condition: or
      - type: word
        part: interactsh_request
        words:
          - "origin-bypass"
          - "validated"
        condition: or

  - address: "{{ws_base}}{{ws_path}}"
    payloads:
      ws_path:
        - "/ws"
        - "/websocket"
        - "/socket.io/"
        - "/api/ws"

    headers:
      Origin: "null"
      X-Forwarded-Host: "{{callback_url}}"
      X-Original-URL: "{{callback_url}}/websocket"

    inputs:
      - data: |
          {
            "type": "null_origin_bypass",
            "forwarded_host": "{{callback_url}}",
            "callback_url": "{{callback_url}}/null-origin"
          }
    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
        condition: or
      - type: word
        part: interactsh_request
        words:
          - "null-origin"

  - address: "{{ws_base}}{{ws_path}}"
    payloads:
      ws_path:
        - "/ws"
        - "/websocket"
        - "/socket.io/"
        - "/api/ws"

    headers:
      Origin: "{{Hostname}}.{{callback_url}}"
      Host: "{{callback_url}}"

    inputs:
      - data: |
          {
            "type": "subdomain_bypass",
            "spoofed_origin": "{{Hostname}}.{{callback_url}}",
            "callback_url": "{{callback_url}}/subdomain-bypass"
          }
      - data: |
          {
            "action": "cors_bypass",
            "bypass_origin": "{{callback_url}}",
            "trusted_domain": "{{callback_url}}",
            "redirect_callback": "{{callback_url}}/cors-success"
          }
    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"
          - "dns"
        condition: or
      - type: word
        part: interactsh_request
        words:
          - "subdomain-bypass"
          - "cors-success"
        condition: or
